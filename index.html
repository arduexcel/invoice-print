<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø³ÛŒØ³ØªÛ•Ù…ÛŒ ÙˆÛ•Ø³ÚµÛŒ ÙˆÛØ³ØªÚ¯Û•</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        :root { --primary: #3498db; --success: #27ae60; --danger: #e74c3c; --dark: #2c3e50; --warning: #f39c12; --parking: #9b59b6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; margin: 0; padding: 0; }

        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.98); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        .container { max-width: 550px; margin: 40px auto; background: white; padding: 30px; border-radius: 12px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .top-bar { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 25px; }
        
        button { cursor: pointer; font-family: inherit; font-weight: bold; border: none; transition: 0.2s; border-radius: 6px; }
        .logout-btn { background: var(--danger); color: white; padding: 8px 15px; }
        .report-btn { background: var(--dark); color: white; padding: 8px 15px; }
        .parking-btn { background: var(--parking); color: white; padding: 8px 15px; }
        .parking-active { background: #6c3483 !important; border: 2px solid white; }

        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none; }
        
        .half-price-btn { position: absolute; left: 10px; top: 35px; background: var(--warning); color: white; padding: 5px 12px; font-size: 12px; display: none; z-index: 5; }
        .btn-full { width: 100%; padding: 15px; background: var(--primary); color: white; font-size: 18px; margin-top: 20px; }

        #report-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 95%; max-width: 900px; max-height: 85vh; overflow-y: auto; }
        .report-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; background: #eee; }
        .tab-btn.active { background: var(--primary); color: white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 14px; }
        .total-box { margin-top: 15px; padding: 15px; background: var(--success); color: white; text-align: center; font-weight: bold; border-radius: 8px; display: none; }

        #invoice-print { display: none; }
        @media print {
            body * { visibility: hidden; }
            #invoice-print, #invoice-print * { visibility: visible; }
            #invoice-print { display: block !important; width: 80mm; text-align: center; direction: rtl; position: absolute; top: 0; left: 0; }
            .print-line { border-bottom: 1px dashed #000; margin: 10px 0; }
        }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2>Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</h2>
        <select id="userSelect" style="margin-bottom:20px;"></select>
        <button onclick="login()" style="width:100%; padding:14px; background:var(--primary); color:white;">Ø¯Ø§Ø®ÚµØ¨ÙˆÙˆÙ†</button>
    </div>
</div>

<div class="container" id="main-content" style="display: none;">
    <div class="top-bar">
        <button class="logout-btn" onclick="logout()">Ú†ÙˆÙˆÙ†Û• Ø¯Û•Ø±Û•ÙˆÛ•</button>
        <div style="display:flex; gap:5px;">
            <button id="parkingModeBtn" class="parking-btn" onclick="toggleParkingMode()">ğŸ…¿ï¸ Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯</button>
            <button class="report-btn" onclick="openReport()">Ú•Ø§Ù¾Û†Ø±Øª</button>
        </div>
    </div>

    <h2 id="main-title" style="text-align:center;">ÙˆÛ•Ø³ÚµÛŒ Ú¯ÙˆØ§Ø³ØªÙ†Û•ÙˆÛ•</h2>

    <div class="form-group">
        <label>Ú©Ø§Ø±Ù…Û•Ù†Ø¯</label>
        <input type="text" id="currentUser" readonly style="background:#f9f9f9;">
    </div>

    <div class="form-group">
        <label>Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¦Û†ØªÛ†Ù…Ø¨ÛÙ„</label>
        <input type="text" id="carNumberInput" oninput="searchCarLocally(this.value)" onkeypress="handleEnter(event)" placeholder="Ú˜Ù…Ø§Ø±Û• Ù„ÛØ±Û• Ø¨Ù†ÙˆØ³Û•..." autofocus>
    </div>

    <div id="duplicate-selector" style="display:none; margin-bottom:15px; background:#fff3cd; padding:10px; border-radius:8px;">
        <label>âš ï¸ ÛŒÛ•Ú©ÛÚ© Ù„Û• Ù‡ÛÚµÛ•Ú©Ø§Ù† Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•:</label>
        <select id="linePicker" onchange="selectManualLine(this.value)"></select>
    </div>
    
    <div id="normal-info-fields">
        <div class="form-group"><label>Ù‡ÛÚµ</label><input type="text" id="resLine" readonly placeholder="..."></div>
    </div>

    <div class="form-group">
        <label>Ù†Ø±Ø®</label>
        <input type="number" id="resPrice" readonly placeholder="0">
        <button id="halfPriceBtn" class="half-price-btn" onclick="makeHalfPrice()">Â½ Ù†ÛŒÙˆÛ•</button>
    </div>

    <div class="form-group">
        <label>ØªÛØ¨ÛŒÙ†ÛŒ</label>
        <input type="text" id="resNote" placeholder="ØªÛØ¨ÛŒÙ†ÛŒ Ù„ÛØ±Û• Ø¨Ù†ÙˆÙˆØ³Û• (Ø¦Ø§Ø±Û•Ø²ÙˆÙˆÙ…Û•Ù†Ø¯Ø§Ù†Û•)...">
    </div>

    <div id="parking-phone-field" class="form-group" style="display: none;">
        <label>Ú˜Ù…Ø§Ø±Û•ÛŒ Ù…Û†Ø¨Ø§ÛŒÙ„</label>
        <input type="text" id="resPhone" placeholder="07xx xxx xxxx">
    </div>

    <button class="btn-full" id="saveBtn" onclick="handleAction()">Ø®Û•Ø²Ù† Ùˆ Ù¾Ú•ÛŒÙ†Øª (Enter)</button>
</div>

<div id="report-modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3>Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ø¦Û•Ù…Ú•Û†</h3>
            <button onclick="closeModal()" style="background:var(--danger); color:white; padding:5px 12px;">Ø¯Ø§Ø®Ø³ØªÙ†</button>
        </div>
        <div class="report-tabs">
            <button id="tabAll" class="tab-btn active" onclick="loadReport('all')">Ù‡Û•Ù…ÙˆÙˆ ÙˆÛ•Ø³ÚµÛ•Ú©Ø§Ù†</button>
            <button id="tabMine" class="tab-btn" onclick="loadReport('mine')">ÙˆÛ•Ø³ÚµÛ•Ú©Ø§Ù†ÛŒ Ø®Û†Ù…</button>
        </div>
        <table>
            <thead><tr><th>Ú©Ø§Øª</th><th>Ú˜Ù…Ø§Ø±Û•</th><th>Ù‡ÛÚµ</th><th>Ú©Ø§Ø±Ù…Û•Ù†Ø¯</th><th>Ù†Ø±Ø®</th><th>Ú©Ø±Ø¯Ø§Ø±</th></tr></thead>
            <tbody id="report-table-body"></tbody>
        </table>
        <div id="totalAmountBox" class="total-box"></div>
    </div>
</div>

<div id="invoice-print">
    <h3 id="p-title">ÙˆÛ•Ø³Úµ</h3>
    <div class="print-line"></div>
    <p>Ú©Ø§Øª: <span id="p-date"></span></p>
    <p>Ú©Ø§Ø±Ù…Û•Ù†Ø¯: <span id="p-user"></span></p>
    <div class="print-line"></div>
    <h1 id="p-num" style="font-size: 40px; margin: 10px 0;"></h1>
    <p id="p-line-row">Ù‡ÛÚµ: <b id="p-line"></b></p>
    <p id="p-phone-row" style="display:none;">Ù…Û†Ø¨Ø§ÛŒÙ„: <b id="p-phone"></b></p>
    <p id="p-note-row" style="display:none;">ØªÛØ¨ÛŒÙ†ÛŒ: <b id="p-note"></b></p>
    <div class="print-line"></div>
    <h2 id="p-price"></h2>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCuUstd-6d0E-EbmQipv2mWk-bA55ajpQ0",
        authDomain: "car-system-4594d.firebaseapp.com",
        projectId: "car-system-4594d",
        storageBucket: "car-system-4594d.firebasestorage.app",
        messagingSenderId: "719030469585",
        appId: "1:719030469585:web:7a23645b9e684b727dd6f0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let allCars = [];
    let isParkingActive = false;

    window.onload = async function() {
        const empSnap = await db.collection("Employees").where("role", "==", "staff").get();
        const select = document.getElementById('userSelect');
        select.innerHTML = '<option value="">Ù‡Û•ÚµØ¨Ú˜Ø§Ø±Ø¯Ù†ÛŒ Ú©Ø§Ø±Ù…Û•Ù†Ø¯...</option>';
        empSnap.forEach(doc => {
            let opt = document.createElement('option');
            opt.value = doc.data().name; opt.innerHTML = doc.data().name;
            select.appendChild(opt);
        });
        const carSnap = await db.collection("Cars").get();
        allCars = carSnap.docs.map(doc => doc.data());
    };

    function searchCarLocally(num) {
        if(isParkingActive || !num) { resetFields(); return; }
        const matches = allCars.filter(c => String(c.number) === String(num));
        const selector = document.getElementById('duplicate-selector');
        const linePicker = document.getElementById('linePicker');

        if(matches.length > 1) {
            selector.style.display = "block";
            linePicker.innerHTML = '<option value="">Ù‡ÛÚµÛ•Ú©Û• Ø¯ÛŒØ§Ø±ÛŒ Ø¨Ú©Û•...</option>';
            matches.forEach((car, index) => {
                linePicker.innerHTML += `<option value="${index}">${car.line} (${car.price})</option>`;
            });
            resetFields();
        } else if(matches.length === 1) {
            selector.style.display = "none";
            setCarData(matches[0]);
        } else {
            selector.style.display = "none";
            resetFields();
        }
    }

    function setCarData(car) {
        document.getElementById('resLine').value = car.line;
        document.getElementById('resPrice').value = car.price;
        if (car.type === "Ù¾Ø§Ø³") {
            document.getElementById('halfPriceBtn').style.display = 'block';
        } else {
            document.getElementById('halfPriceBtn').style.display = 'none';
        }
    }

    function selectManualLine(index) {
        if(index === "") return;
        const num = document.getElementById('carNumberInput').value;
        const matches = allCars.filter(c => String(c.number) === String(num));
        setCarData(matches[index]);
    }

    function makeHalfPrice() {
        const pInput = document.getElementById('resPrice');
        let currentPrice = parseInt(pInput.value);
        if(currentPrice === 6500) { pInput.value = 3000; }
        else if(currentPrice > 0) { pInput.value = Math.floor(currentPrice / 2); }
    }

    async function handleAction() {
        const numInput = document.getElementById('carNumberInput');
        const num = numInput.value;
        const price = document.getElementById('resPrice').value;
        const note = document.getElementById('resNote').value;
        const line = isParkingActive ? "Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯" : document.getElementById('resLine').value;
        const uName = document.getElementById('currentUser').value;

        if(!num || !price || !line) return alert("Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù† ØªÛ•ÙˆØ§Ùˆ Ù†ÛŒÙ†");

        const data = {
            employee: uName,
            carNumber: num,
            price: price,
            note: note,
            phone: isParkingActive ? document.getElementById('resPhone').value : "",
            isParking: isParkingActive,
            line: line,
            searchDate: new Date().toLocaleDateString('en-CA'),
            date: new Date().toLocaleString('ku-IQ'),
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection("Invoices").add(data);
        printInvoice(data);
        
        numInput.value = "";
        document.getElementById('resPhone').value = "";
        document.getElementById('resNote').value = "";
        resetFields();
        numInput.focus();
    }

    function printInvoice(data) {
        document.getElementById('p-title').innerText = data.isParking ? "ÙˆÛ•Ø³ÚµÛŒ Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯" : "ÙˆÛ•Ø³ÚµÛŒ Ú¯ÙˆØ§Ø³ØªÙ†Û•ÙˆÛ•";
        document.getElementById('p-num').innerText = data.carNumber;
        document.getElementById('p-line').innerText = data.line;
        document.getElementById('p-price').innerText = data.price + " Ø¯ÛŒÙ†Ø§Ø±";
        document.getElementById('p-user').innerText = data.employee;
        document.getElementById('p-date').innerText = data.date;
        document.getElementById('p-phone-row').style.display = data.isParking ? "block" : "none";
        document.getElementById('p-phone').innerText = data.phone || "";
        
        // Ù¾ÛŒØ´Ø§Ù†Ø¯Ø§Ù†ÛŒ ØªÛØ¨ÛŒÙ†ÛŒ Ù„Û• Ù¾Ú•ÛŒÙ†Øª Ø¦Û•Ú¯Û•Ø± Ù‡Û•Ø¨ÙˆÙˆ
        const pNoteRow = document.getElementById('p-note-row');
        if(data.note) {
            pNoteRow.style.display = "block";
            document.getElementById('p-note').innerText = data.note;
        } else {
            pNoteRow.style.display = "none";
        }
        
        window.print();
    }

    async function loadReport(mode) {
        const today = new Date().toLocaleDateString('en-CA');
        const currentUser = document.getElementById('currentUser').value;
        document.getElementById('tabAll').classList.toggle('active', mode === 'all');
        document.getElementById('tabMine').classList.toggle('active', mode === 'mine');
        const totalBox = document.getElementById('totalAmountBox');

        const snap = await db.collection("Invoices").where("searchDate", "==", today).get();
        const tbody = document.getElementById('report-table-body');
        tbody.innerHTML = "";
        let total = 0;

        const docs = snap.docs.sort((a,b) => (b.data().timestamp?.seconds || 0) - (a.data().timestamp?.seconds || 0));
        
        docs.forEach(doc => {
            const d = doc.data();
            if(mode === 'mine' && d.employee !== currentUser) return;
            total += parseInt(d.price);
            tbody.innerHTML += `<tr>
                <td>${d.date.split(',')[1] || d.date}</td>
                <td>${d.carNumber}</td>
                <td>${d.line}</td>
                <td>${d.employee}</td>
                <td>${parseInt(d.price).toLocaleString()}</td>
                <td><button class="reprint-btn" onclick='printInvoice(${JSON.stringify(d)})' style="background:var(--warning); padding:4px 8px;">Ù¾Ú•ÛŒÙ†Øª</button></td>
            </tr>`;
        });

        if(mode === 'mine') {
            totalBox.style.display = "block";
            totalBox.innerText = "Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ: " + total.toLocaleString() + " Ø¯ÛŒÙ†Ø§Ø±";
        } else {
            totalBox.style.display = "none";
        }
    }

    function toggleParkingMode() {
        isParkingActive = !isParkingActive;
        const btn = document.getElementById('parkingModeBtn');
        btn.classList.toggle('parking-active');
        document.getElementById('main-title').innerText = isParkingActive ? "ÙˆÛ•Ø³ÚµÛŒ Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯" : "ÙˆÛ•Ø³ÚµÛŒ Ú¯ÙˆØ§Ø³ØªÙ†Û•ÙˆÛ•";
        document.getElementById('parking-phone-field').style.display = isParkingActive ? "block" : "none";
        document.getElementById('normal-info-fields').style.display = isParkingActive ? "none" : "block";
        document.getElementById('resPrice').readOnly = !isParkingActive;
        if(isParkingActive) {
            document.getElementById('resPrice').value = "";
            document.getElementById('resPrice').focus();
            document.getElementById('halfPriceBtn').style.display = 'none';
        } else {
            searchCarLocally(document.getElementById('carNumberInput').value);
        }
    }

    function resetFields() {
        document.getElementById('resLine').value = "";
        document.getElementById('resPrice').value = "";
        document.getElementById('duplicate-selector').style.display = "none";
        document.getElementById('halfPriceBtn').style.display = 'none';
    }

    function login() {
        const u = document.getElementById('userSelect').value;
        if(!u) return alert("Ú©Ø§Ø±Ù…Û•Ù†Ø¯ Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•");
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('currentUser').value = u;
        setTimeout(() => document.getElementById('carNumberInput').focus(), 100);
    }

    function logout() { location.reload(); }
    function handleEnter(e) { if(e.key === "Enter") handleAction(); }
    function openReport() { document.getElementById('report-modal').style.display = 'flex'; loadReport('all'); }
    function closeModal() { document.getElementById('report-modal').style.display = 'none'; }
</script>
</body>
</html>
